<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>Work Logger ¬∑ Anti-Fake GPS ¬∑ Violation Logger</title>
    <style>
        * { box-sizing: border-box; font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 0; }
        body {
            background: linear-gradient(145deg, #eef2f7, #e2e8f0);
            min-height: 100vh;
            display: flex; align-items: center; justify-content: center; padding: 20px;
        }
        .container {
            max-width: 600px; width: 100%; background: white; border-radius: 40px;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.15); padding: 36px 28px;
            border: 1px solid rgba(255,255,255,0.5);
        }
        h1 { font-size: 2rem; color: #0f2c3d; margin-bottom: 12px; font-weight: 700; }
        .badge {
            background: #e6f0f5; padding: 12px 20px; border-radius: 100px; font-size: 0.95rem;
            color: #1f5068; border-left: 4px solid #2c7da0; margin: 20px 0;
        }
        .btn {
            border: none; padding: 16px 28px; border-radius: 60px; font-size: 1.1rem;
            font-weight: 600; cursor: pointer; transition: all 0.15s; display: flex;
            align-items: center; justify-content: center; gap: 10px; border: 1px solid rgba(0,0,0,0.02);
        }
        .btn-primary { background: #1e4a6b; color: white; flex: 1; box-shadow: 0 8px 16px rgba(30,74,107,0.25); }
        .btn-primary:hover { background: #256f94; transform: scale(0.98); }
        .btn-primary:disabled { background: #a0b9c9; transform: none; box-shadow: none; cursor: not-allowed; }
        .btn-secondary { background: #f0f4f8; color: #1e4a6b; flex: 1; }
        .btn-secondary:hover { background: #e2eaf1; }
        .button-row { display: flex; gap: 16px; margin: 24px 0; }
        input {
            width: 100%; padding: 16px 22px; font-size: 1.1rem; border: 2px solid #d0dfe8;
            border-radius: 50px; margin: 8px 0 20px; outline: none;
        }
        input:focus { border-color: #2c7da0; box-shadow: 0 0 0 4px rgba(44,125,160,0.1); }
        .status {
            background: #f0f6fa; padding: 16px 22px; border-radius: 30px; margin-top: 24px;
            color: #1e4a6b; border-left: 6px solid #2c7da0; word-break: break-word;
        }
        .hidden { display: none; }
        .register-box { background: #f8fafc; padding: 28px; border-radius: 32px; margin-top: 16px; }
        .error { color: #b34141; font-size: 0.95rem; margin-top: 8px; }
        .location-prompt {
            background: #fff8e7; border-left: 6px solid #ed8a3c; padding: 16px 22px;
            border-radius: 30px; margin: 20px 0; display: flex; align-items: center; gap: 12px;
        }
        .location-allowed { background: #e3f2ed; border-left-color: #2e7d32; }
        .nid-warning {
            background: #fff3e0; border-left: 6px solid #ed8a3c; padding: 16px 22px;
            border-radius: 30px; margin: 20px 0; display: flex; align-items: center; gap: 12px;
        }
        .gps-verified {
            background: #e0f2e0; border-left: 6px solid #1e6f1e; padding: 12px 20px;
            border-radius: 30px; margin-top: 12px; font-size: 0.9rem;
        }
        .violation-badge {
            background: #ffebee; border-left: 6px solid #b71c1c; padding: 12px 20px;
            border-radius: 30px; margin-top: 12px; font-size: 0.9rem; color: #b71c1c;
        }
    </style>
</head>
<body>
    <div class="container" id="app">
        <!-- Dynamic content -->
    </div>

    <script>
        // üî¥ REPLACE WITH YOUR ACTUAL WEB APP URL (Google Apps Script)
        const SHEET_WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbw1hIxGZXrjdf6izCMBwO98BuGZnYB3Q4I26QciCixTesJsLoZEmbcMjJyDLWMVopfp/exec';
        
        // Storage keys
        const DEVICE_ID_KEY = 'work_device_id';
        const NID_STORAGE_KEY = 'registered_nid';
        
        // Global state
        let deviceId = localStorage.getItem(DEVICE_ID_KEY);
        let registeredNid = localStorage.getItem(NID_STORAGE_KEY) || null;
        
        // GPS state ‚Äì STRICT: only real GPS with high accuracy, no fake, no network
        let gpsPermission = false;          // true only after REAL GPS fix
        let lastRealGpsString = null;      // stores verified lat,lng
        let gpsAccuracy = null;            // accuracy in meters
        let gpsTimestamp = null;           // when fix was obtained

        // ========== INIT ==========
        async function init() {
            renderWelcome();
        }

        
        // ========== STRICT GPS: VALIDATE, REJECT FAKE, LOG VIOLATIONS ==========
        async function attemptRealGps() {
            if (!navigator.geolocation) {
                throw new Error('Geolocation not supported');
            }
            try {
                // Request high accuracy GPS with no cached positions
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 15000,
                        maximumAge: 0
                    });
                });
                
                const coords = position.coords;
                const accuracy = coords.accuracy;
                let isViolation = false;
                let violationReason = '';
                // ---------- DETECT FAKE / NETWORK / POOR ACCURACY ----------
                // 1. Check for mock location (Android, iOS simulator, fake GPS apps)
                // @ts-ignore
                if (coords.mock === true || coords.mock === 'true' || position.mock === true) {
                    isViolation = true;
                    violationReason = 'MOCK_LOCATION_DETECTED';
                }
                
                // 2. Check accuracy threshold (network locations usually > 30m)
                else if (accuracy > 30) {
                    isViolation = true;
                    violationReason = `ACCURACY_TOO_LOW_${accuracy.toFixed(1)}m`;
                }
                
                // 3. Additional heuristic: real GPS typically provides altitude and speed
                // If both are null and accuracy > 20, likely network
                else if (coords.altitude === null && coords.speed === null && accuracy > 20) {
                    isViolation = true;
                    violationReason = `SUSPECTED_NETWORK_LOCATION_${accuracy.toFixed(1)}m`;
                }

                // ---------- LOG VIOLATION TO GOOGLE SHEET ----------
                if (isViolation) {
                    const now = new Date();
                    const date = now.toLocaleDateString('en-CA');
                    const time = now.toLocaleTimeString('en-GB', { hour12: false });
                    
                    const violationRow = [
                        date,
                        time,
                        deviceId || 'NO_DEVICE_ID',
                        `${coords.latitude.toFixed(6)}, ${coords.longitude.toFixed(6)}`,
                        'GPS_VIOLATION',
                        violationReason,
                        `Accuracy: ${accuracy}m`,
                        coords.altitude || 'null',
                        coords.speed || 'null',
                        navigator.userAgent
                    ];
                    
                    // Send violation to sheet (fire and forget)
                    fetch(SHEET_WEBAPP_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ values: violationRow })
                    }).catch(e => console.error('Violation log failed:', e));
                    
                    throw new Error(violationReason);
                }

                // ---------- REAL GPS ACCEPTED ----------
                gpsPermission = true;
                lastRealGpsString = `${coords.latitude.toFixed(6)}, ${coords.longitude.toFixed(6)}`;
                gpsAccuracy = accuracy;
                gpsTimestamp = new Date().toISOString();
                
                return true;
                
            } catch (err) {
                // If it's already our custom error, rethrow
                gpsPermission = false;
                lastRealGpsString = null;
                throw err;
            }
        }

        // Wrapper that attempts real GPS and handles violations
        async function requestRealGpsWithViolationLogging() {
            try {
                await attemptRealGps();
                return { success: true, violation: false };
            } catch (err) {
                return { 
                    success: false, 
                    violation: true, 
                    reason: err.message 
                };
            }
        }

        // ========== DEVICE ID ==========
        function generateDeviceId() {
            const timestamp = Date.now().toString(36).toUpperCase();
            const random = Math.random().toString(36).substring(2, 10).toUpperCase();
            return (timestamp + random).slice(0, 14).padEnd(14, '0');
        }

        // ========== SHEET LOGGING (GENERIC) ==========
        async function sendToSheet(rowData) {
            try {
                await fetch(SHEET_WEBAPP_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ values: rowData })
                });
                return { success: true };
            } catch (error) {
                console.error('Send error:', error);
                throw error;
            }
        }

        // ========== RENDER: WELCOME ==========
        function renderWelcome() {
            const hasDevice = deviceId !== null;
            const hasGps = gpsPermission === true;
            
            // ---------- GPS Badge or Enable Prompt ----------
            let gpsBadge = '';
            if (hasGps) {
                gpsBadge = `<div class="badge location-allowed" style="background:#e3f2ed; border-left-color:#2e7d32;">
                    <span>üõ∞Ô∏è REAL GPS: <strong>ACTIVE</strong></span>
                    <div style="font-size:0.85rem; margin-top:6px;">
                        üìç ${lastRealGpsString}<br>
                        üéØ Accuracy: ${gpsAccuracy}m ¬∑ ${new Date(gpsTimestamp).toLocaleTimeString()}
                    </div>
                </div>`;
            } else {
                gpsBadge = `<div class="location-prompt">
                    <span style="font-size:1.5rem;">üõ∞Ô∏è</span>
                    <div style="flex:1;">
                        <strong>Real GPS required</strong><br>
                        ‚Ä¢ No fake GPS apps<br>
                        ‚Ä¢ No network/wifi locations<br>
                        ‚Ä¢ Accuracy ‚â§ 30 meters<br>
                        <span style="color:#b71c1c; font-size:0.85rem;">Violations are logged to sheet</span>
                    </div>
                    <button id="enableGpsBtn" class="btn" style="background:#1e4a6b; color:white; padding:12px 20px; border-radius:40px;">Activate GPS</button>
                </div>`;
            }

            // ---------- NID / Device Registration Prompt ----------
            let registrationPrompt = '';
            if (!hasDevice) {
                registrationPrompt = `<div class="nid-warning">
                    <span style="font-size:1.5rem;">üÜî</span>
                    <div style="flex:1;"><strong>No device registered</strong><br>Please register your 14-digit NID to create a device ID.</div>
                    <button id="registerRedirectBtn" class="btn" style="background:#1e4a6b; color:white; padding:12px 20px; border-radius:40px;">Register</button>
                </div>`;
            }

            // ---------- Main Render ----------
            document.getElementById('app').innerHTML = `
                <div>
                    <h1>‚è±Ô∏è Work Logger</h1>
                    <p style="color: #3c6e71; margin-bottom: 16px;">üõ∞Ô∏è ANTI-FAKE GPS ¬∑ Violations reported</p>
                    
                    ${hasDevice ? 
                        `<div class="badge">
                            <span style="font-weight:bold;">üñ•Ô∏è DEVICE ID:</span> ${deviceId}
                        </div>` : 
                        ''
                    }
                    
                    ${registrationPrompt}
                    ${gpsBadge}
                    
                    <div class="button-row">
                        <button class="btn btn-primary" id="startBtn" ${!hasDevice || !hasGps ? 'disabled' : ''}>
                            üìã Start/Finish Work
                        </button>
                        <button class="btn btn-secondary" id="otherBtn">üîß Other Services</button>
                    </div>
                    
                    <div id="statusMessage" class="status hidden"></div>
                    
                    <p style="font-size:0.8rem; color:#5f7d95; margin-top:24px; text-align:center;">
                        ‚ö†Ô∏è Fake GPS, network location, or accuracy >30m = automatic violation report
                    </p>
                </div>
            `;

            // ---------- Event Listeners ----------
            document.getElementById('startBtn')?.addEventListener('click', handleWork);
            document.getElementById('otherBtn')?.addEventListener('click', handleOther);
            
            const enableBtn = document.getElementById('enableGpsBtn');
            if (enableBtn) {
                enableBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    const btn = e.currentTarget;
                    btn.textContent = 'üõ∞Ô∏è Checking GPS...';
                    btn.disabled = true;
                    
                    const result = await requestRealGpsWithViolationLogging();
                    
                    if (result.success) {
                        renderWelcome();
                    } else {
                        // Violation detected and already logged to sheet
                        alert(`‚ùå Real GPS required.\nReason: ${result.reason}\n\nThis violation has been recorded.`);
                        renderWelcome();
                    }
                });
            }

            // Register redirect
            const registerRedirectBtn = document.getElementById('registerRedirectBtn');
            if (registerRedirectBtn) {
                registerRedirectBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    renderRegisterNID();
                });
            }
        }

        // ========== RENDER: REGISTER NID ==========
        function renderRegisterNID() {
            document.getElementById('app').innerHTML = `
                <div>
                    <h1>üÜî Device Registration</h1>
                    <p style="color: #3c6e71; margin-bottom: 24px;">
                        No device ID found. Enter your 14-digit National ID (NID) to register this device.
                    </p>
                    
                    <div class="register-box">
                        <label style="font-weight:600; color:#1e4a6b;">üèõÔ∏è National ID (NID)</label>
                        <input type="text" id="nidInput" maxlength="14" placeholder="14 digits, e.g. 12345678901234" inputmode="numeric" autofocus>
                        
                        <div class="button-row">
                            <button class="btn btn-primary" id="registerBtn">‚úîÔ∏è Register & Create Device ID</button>
                            <button class="btn btn-secondary" id="backBtn">‚Üê Back</button>
                        </div>
                        
                        <div id="registerError" class="error"></div>
                    </div>
                </div>
            `;
            
            document.getElementById('registerBtn').addEventListener('click', handleRegister);
            document.getElementById('backBtn').addEventListener('click', () => renderWelcome());
        }

        // ========== RENDER: OTHER SERVICES ==========
        function renderOther() {
            document.getElementById('app').innerHTML = `
                <div style="text-align:center; padding:20px 0;">
                    <div style="font-size:4rem; margin-bottom:20px;">üõ†Ô∏è</div>
                    <h2 style="color:#1e4a6b; margin-bottom:16px;">Other Services</h2>
                    <p style="color:#3c6e71; margin-bottom:32px;">This page is intentionally empty.</p>
                    <button class="btn btn-primary" id="backBtn" style="margin:0 auto;">‚Üê Back to Welcome</button>
                </div>
            `;
            document.getElementById('backBtn').addEventListener('click', () => renderWelcome());
        }

        // ========== HANDLE: REGISTRATION ==========
        async function handleRegister() {
            const nidInput = document.getElementById('nidInput');
            const errorEl = document.getElementById('registerError');
            const nid = nidInput.value.trim();
            
            if (!/^\d{14}$/.test(nid)) {
                errorEl.textContent = '‚ùå Please enter exactly 14 numeric digits.';
                return;
            }
            
            const newDeviceId = generateDeviceId();
            localStorage.setItem(DEVICE_ID_KEY, newDeviceId);
            localStorage.setItem(NID_STORAGE_KEY, nid);
            
            deviceId = newDeviceId;
            registeredNid = nid;
            
            errorEl.textContent = '‚è≥ Registering device...';
            errorEl.style.color = '#1e4a6b';
            
            try {
                const now = new Date();
                const date = now.toLocaleDateString('en-CA');
                const time = now.toLocaleTimeString('en-GB', { hour12: false });
                
                const row = [date, time, newDeviceId, `NID: ${nid}`, 'DEVICE_REGISTRATION'];
                await sendToSheet(row);
                
                errorEl.textContent = '‚úÖ Device registered! Redirecting...';
                errorEl.style.color = '#2e7d32';
                
                setTimeout(() => renderWelcome(), 1500);
                
            } catch (error) {
                errorEl.textContent = '‚ö†Ô∏è Device saved locally, but sheet update failed. You can still proceed.';
                errorEl.style.color = '#b85c1a';
                setTimeout(() => renderWelcome(), 2000);
            }
        }

        // ========== HANDLE: WORK (REQUIRES REAL GPS) ==========
        async function handleWork() {
            const statusEl = document.getElementById('statusMessage');
            statusEl.classList.remove('hidden');
            
            if (!deviceId) {
                statusEl.innerHTML = '‚ö†Ô∏è No device ID. Redirecting to registration...';
                statusEl.style.background = '#ffebee';
                setTimeout(() => renderRegisterNID(), 1500);
                return;
            }
            
            if (!gpsPermission) {
                statusEl.innerHTML = '‚ùå Real GPS not enabled. Please activate GPS first.';
                statusEl.style.background = '#ffebee';
                return;
            }
            
            try {
                statusEl.innerHTML = 'üõ∞Ô∏è Verifying real GPS before work event...';
                
                // CRITICAL: Re-verify GPS for every work attempt
                // This will catch any fake GPS that was activated after initial permission
                const gpsResult = await requestRealGpsWithViolationLogging();
                
                if (!gpsResult.success) {
                    // Violation detected and logged
                    gpsPermission = false;
                    renderWelcome();
                    throw new Error(`GPS violation: ${gpsResult.reason}`);
                }
                
                // If we get here, we have a fresh real GPS fix
                const location = lastRealGpsString;
                const accuracy = gpsAccuracy;
                
                const now = new Date();
                const date = now.toLocaleDateString('en-CA');
                const time = now.toLocaleTimeString('en-GB', { hour12: false });
                
                statusEl.innerHTML = `üì§ Sending work event to Google Sheets (accuracy: ${accuracy}m)...`;
                
                const row = [date, time, deviceId, location, 'WORK_EVENT', `Accuracy: ${accuracy}m`, 'REAL_GPS_VERIFIED'];
                await sendToSheet(row);
                
                statusEl.innerHTML = `‚úÖ Work event recorded! Real GPS: ${location} (${accuracy}m)`;
                statusEl.style.background = '#e3f2ed';
                
            } catch (error) {
                statusEl.innerHTML = '‚ùå ' + error.message;
                statusEl.style.background = '#ffebee';
            }
        }

        // ========== HANDLE: OTHER ==========
        function handleOther() {
            renderOther();
        }

        function compareLocations(locations) {
            if (!locations.gps || !locations.network) {
                alert('gps'+locations.gps.coords+'network'+locations.network.coords)
                return
            }
  
            const distance = calculateDistance(
            locations.gps.coords,
            locations.network.coords
            )
            alert('step 2'+distance+'!')
            // If GPS and network locations are very different
            if (distance > 1000) { // More than 1km difference
            alert('Fake GPS')
            }
        }
        // ========== START ==========
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>